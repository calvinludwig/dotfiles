#!/usr/bin/env bash

# Script to list AWS EC2 instances with optional name filtering
# Usage: ./list-aws-instances.sh [--name instance-name] [--region region-name]

set -e

# Default values
REGION="${AWS_DEFAULT_REGION:-us-east-1}"
NAME_FILTER=""
PROFILE=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Help function
show_help() {
  cat <<EOF
Usage: ${0##*/} [OPTIONS]

List AWS EC2 instances with optional name filtering.

OPTIONS:
    -n, --name NAME                 Filter instances by name (partial match, case-sensitive)
    -r, --region REGION             AWS region (default: $REGION)
    -p, --profile PROFILE           AWS CLI profile to use
    -h, --help                      Display this help message
    -v, --verbose                   Show detailed instance information

EXAMPLES:
    # List all instances in default region
    ${0##*/}

    # List instances containing "web" in the name
    ${0##*/} --name web

    # List instances containing "prod"
    ${0##*/} --name prod

    # List instances in specific region
    ${0##*/} --region us-west-2

    # List instances with name filter and profile
    ${0##*/} --name server --profile prod --verbose

EOF
}

# Parse command line arguments
VERBOSE=false
while [[ $# -gt 0 ]]; do
  case $1 in
  -n | --name)
    NAME_FILTER="$2"
    shift 2
    ;;
  -r | --region)
    REGION="$2"
    shift 2
    ;;
  -p | --profile)
    PROFILE="$2"
    shift 2
    ;;
  -v | --verbose)
    VERBOSE=true
    shift
    ;;
  -h | --help)
    show_help
    exit 0
    ;;
  *)
    echo -e "${RED}Error: Unknown option: $1${NC}"
    show_help
    exit 1
    ;;
  esac
done

# Build AWS CLI command
AWS_CMD="aws ec2 describe-instances --region $REGION"

# Add profile if specified
if [ -n "$PROFILE" ]; then
  AWS_CMD="$AWS_CMD --profile $PROFILE"
fi

# Add name filter if specified
if [ -n "$NAME_FILTER" ]; then
  # Automatically add wildcards for partial matching
  AWS_CMD="$AWS_CMD --filters Name=tag:Name,Values=*$NAME_FILTER*"
  echo -e "${YELLOW}Filtering by name containing: $NAME_FILTER${NC}"
fi

echo -e "${GREEN}Fetching instances from region: $REGION${NC}"
echo ""

# Check if AWS CLI is installed
if ! command -v aws &>/dev/null; then
  echo -e "${RED}Error: AWS CLI is not installed${NC}"
  exit 1
fi

# Execute AWS CLI command and format output
if [ "$VERBOSE" = true ]; then
  # Detailed output
  $AWS_CMD --query 'Reservations[*].Instances[*].[
        InstanceId,
        InstanceType,
        State.Name,
        PrivateIpAddress,
        PublicIpAddress,
        Tags[?Key==`Name`].Value | [0],
        LaunchTime,
        Placement.AvailabilityZone
    ]' --output table
else
  # Compact output
  $AWS_CMD --query 'Reservations[*].Instances[*].[
        InstanceId,
        InstanceType,
        State.Name,
        PrivateIpAddress,
        PublicIpAddress,
        Tags[?Key==`Name`].Value | [0]
    ]' --output table --no-cli-pager
fi

# Count instances
INSTANCE_COUNT=$($AWS_CMD --query 'length(Reservations[*].Instances[*][])' --output text)

echo ""
echo -e "${GREEN}Total instances found: $INSTANCE_COUNT${NC}"

# Show legend
echo ""
echo "Columns: InstanceId | InstanceType | State | PrivateIP | PublicIP | Name"
if [ "$VERBOSE" = true ]; then
  echo "         (+ LaunchTime | AvailabilityZone)"
fi
