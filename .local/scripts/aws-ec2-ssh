#!/usr/bin/env bash

# Script to list AWS EC2 instances with fzf and SSH to selected instance
# Requires: aws cli, fzf, and SSH config with SSM proxy setup

set -e

# Default values
REGION="${AWS_DEFAULT_REGION:-us-east-1}"
PROFILE=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Help function
show_help() {
  cat <<EOF
Usage: ${0##*/} [OPTIONS]

List AWS EC2 instances with fzf and SSH to the selected one.

OPTIONS:
    -r, --region REGION             AWS region (default: $REGION)
    -p, --profile PROFILE           AWS CLI profile to use
    -h, --help                      Display this help message

REQUIREMENTS:
    - AWS CLI installed and configured
    - fzf installed (fuzzy finder)
    - SSH configured with AWS SSM proxy command

EXAMPLES:
    # List and select instance from default region
    ${0##*/}

    # Use specific region
    ${0##*/} --region us-west-2

    # Use specific AWS profile
    ${0##*/} --profile prod

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  -r | --region)
    REGION="$2"
    shift 2
    ;;
  -p | --profile)
    PROFILE="$2"
    shift 2
    ;;
  -h | --help)
    show_help
    exit 0
    ;;
  *)
    echo -e "${RED}Error: Unknown option: $1${NC}"
    show_help
    exit 1
    ;;
  esac
done

# Check if AWS CLI is installed
if ! command -v aws &>/dev/null; then
  echo -e "${RED}Error: AWS CLI is not installed${NC}"
  exit 1
fi

# Check if fzf is installed
if ! command -v fzf &>/dev/null; then
  echo -e "${RED}Error: fzf is not installed${NC}"
  echo "Install with: sudo pacman -S fzf  (or brew install fzf / apt install fzf)"
  exit 1
fi

# Build AWS CLI command
AWS_CMD="aws ec2 describe-instances --region $REGION"

# Add profile if specified
if [ -n "$PROFILE" ]; then
  AWS_CMD="$AWS_CMD --profile $PROFILE"
fi

echo -e "${GREEN}Fetching instances from region: $REGION${NC}"

# Fetch instances and format for fzf
# Format: "InstanceID | Name | State | InstanceType | PrivateIP | PublicIP"
INSTANCES=$($AWS_CMD \
  --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],State.Name,InstanceType,PrivateIpAddress,PublicIpAddress]' \
  --output text |
  awk '{printf "%-20s | %-30s | %-10s | %-15s | %-15s | %-15s\n", $1, ($2 ? $2 : "N/A"), $3, $4, ($5 ? $5 : "N/A"), ($6 ? $6 : "N/A")}')

# Check if any instances were found
if [ -z "$INSTANCES" ]; then
  echo -e "${RED}No instances found in region $REGION${NC}"
  exit 1
fi

# Use fzf to select an instance
SELECTED=$(echo "$INSTANCES" | fzf \
  --header="Select an EC2 instance to SSH into (ESC to cancel)" \
  --height=40% \
  --reverse \
  --border \
  --prompt="Search: " \
  --preview-window=hidden)

# Check if user cancelled selection
if [ -z "$SELECTED" ]; then
  echo -e "${YELLOW}No instance selected. Exiting.${NC}"
  exit 0
fi

# Extract instance ID (first field)
INSTANCE_ID=$(echo "$SELECTED" | awk '{print $1}')
INSTANCE_NAME=$(echo "$SELECTED" | awk '{print $3}')

echo -e "${GREEN}Connecting to instance: $INSTANCE_ID${NC}"
if [ "$INSTANCE_NAME" != "N/A" ]; then
  echo -e "${GREEN}Name: $INSTANCE_NAME${NC}"
fi
echo ""

# SSH to the instance
# Note: This requires SSH config with ProxyCommand set up for AWS SSM
# Example ~/.ssh/config:
# Host i-* mi-*
#   ProxyCommand sh -c "aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p'"
#   User ec2-user

ssh "$INSTANCE_ID"
